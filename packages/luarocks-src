#!/bin/bash

set -eu

CM_BIN_PATH="$HOME/.config/crools/crackman/bin"
CM_SRC_PATH="$HOME/.config/crools/crackman/src"

mkdir -p "$CM_BIN_PATH"
mkdir -p "$CM_SRC_PATH"

if [ "${1:-}" == "description" ]
then
	echo "The package manager for Lua modules"
elif [ "${1:-}" == "delete" ]
then
	cd "$CM_SRC_PATH"/luarocks
	sudo make uninstall
	cd ..
	rm -rf "$CM_SRC_PATH"/luarocks

	rock_eval='eval "$(luarocks path)"'
	if ! grep -qF "$rock_eval" ~/.bashrc
	then
		echo "[*] removing luarocks ~/.bashrc entry"
		grep -vF "$rock_eval" ~/.bashrc > ~/.bashrc.tmp
		mv ~/.bashrc.tmp ~/.bashrc
	fi
elif [ "${1:-}" == "is_installed?" ]
then
	if [ -d "$CM_SRC_PATH"/luarocks ]
	then
		echo "yes"
		exit 1
	else
		echo "no"
		exit 0
	fi
else
	distro="$(grep "^ID=" /etc/os-release | cut -d'=' -f2)"
	if [ "$distro" != "debian" ]
	then
		echo "Error: luarocks is only supported on debian"
		exit 1
	fi
	if [ ! -x "$(command -v fzf)" ]
	then
		sudo apt-get install -y fzf || exit 1
	fi

	cd "$CM_SRC_PATH" || exit 1
	if [ ! -d "luarocks" ]
	then
		git clone git@github.com:luarocks/luarocks.git
	fi
	cd luarocks
	tag="$( (git tag && printf 'main\n') | fzf)"
	if [ "$tag" == "" ]
	then
		echo "Error: invalid tag"
		exit 1
	fi
	git pull
	git checkout "$tag" || exit 1
	git pull

	./configure --with-lua-include=/usr/local/include
	make
	sudo make install

	rock_eval='eval "$(luarocks path)"'
	if ! grep -qF "$rock_eval" ~/.bashrc
	then
		echo "[*] setting up ~/.bashrc for luarocks"
		printf '\n%s\n' "$rock_eval" >> ~/.bashrc
	fi

	# inform luarocks about the custom lua install headers
	cd "$CM_SRC_PATH"
	versions="$(echo lua-* | tr ' ' '\n' | grep -v '.tar.gz$')"
	version="$(printf '%s' "$versions" | tr ' ' '\n' | fzf)"
	if [ "$version" = "" ]
	then
		echo "aborting..."
		exit 1
	fi
	if [[ "$version" =~ [0-9]+\.[0-9]+ ]]
	then
		abi_version="${BASH_REMATCH[0]}"
	else
		echo "[-] Error: failed to parse lua abi version from version '$version'"
		exit 1
	fi
	echo "[*] lua abi version $abi_version"
	if [ -x "$(command -v luarocks)" ]
	then
		include_dir="/usr/local/include/lua${abi_version}"
		echo "[*] configure luarocks to use $include_dir"
		luarocks config variables.LUA_INCDIR "$include_dir"
	fi
fi

