#!/bin/bash

set -eu

CM_BIN_PATH="$HOME/.config/crools/crackman/bin"
CM_SRC_PATH="$HOME/.config/crools/crackman/src"

mkdir -p "$CM_BIN_PATH"
mkdir -p "$CM_SRC_PATH"


if [ "${1:-}" == "description" ]
then
	echo "lua programming language built from source"
elif [ "${1:-}" == "delete" ]
then
	cd "$CM_SRC_PATH"
	versions="$(echo lua-* | tr ' ' '\n' | grep -v '.tar.gz$')"
	version="$(printf '%s' "$versions" | tr ' ' '\n' | fzf)"
	if [ "$version" = "" ]
	then
		echo "aborting..."
		exit 1
	fi

	if [[ "$version" =~ [0-9]+\.[0-9]+ ]]
	then
		abi_version="${BASH_REMATCH[0]}"
	else
		echo "[-] Error: failed to parse lua abi version from version '$version'"
		exit 1
	fi
	echo "[*] abi version $abi_version"

	# luarocks can break if we remove lua
	# it can hardlink to a binary called lua5.5
	# so we need to configure it first before it breaks
	# not sure how much sense this makes as its broken either way then :D
	# but at least we don't throw and error on uninstall
	# i guess crackman needs some kind of dependency system that would alert that
	# uninstalling lua breaks luarocks
	if [ -x "$(command -v luarocks)" ]
	then
		include_dir="/usr/local/include/lua${abi_version}"
		if [ "$(luarocks config variables.LUA_INCDIR)" = "$include_dir" ]
		then
			echo "[*] clearing luarocks lua include directory"
			luarocks config variables.LUA_INCDIR ""
		fi
	fi

	sudo rm -rf /usr/local/include/lua"$abi_version"
	sudo rm /usr/local/lib/liblua${abi_version}.a
	sudo rm /usr/local/bin/lua${abi_version}
	sudo rm /usr/local/bin/luac${abi_version}

	# cd "$version"
	# sudo make uninstall
	# cd ..

	rm -rf "$version"
	rm "$version".tar.gz

	# delete sym link only if it was pointing to that exact lua version
	if ls -lah "$CM_BIN_PATH"/lua | grep -q "lua${abi_version}$"
	then
		echo "[*] removing lua from PATH"
		rm "$CM_BIN_PATH"/lua
	fi
	if ls -lah "$CM_BIN_PATH"/luac | grep -q "luac${abi_version}$"
	then
		echo "[*] removing luac from PATH"
		rm "$CM_BIN_PATH"/luac
	fi
elif [ "${1:-}" == "is_installed?" ]
then
	shopt -s nullglob
	for f in "$CM_SRC_PATH"/lua-*; do
		echo "yes"
		exit 1
	done

	echo "no"
	exit 0
else
	cd "$CM_SRC_PATH" || exit 1

	abi_version=5.5
	version=lua-"$abi_version".0.tar.gz
	if ! versions="$(curl -s https://www.lua.org/ftp/ | grep -o '"lua-[0-9].*.tar.gz"' | cut -d'"' -f2)"
	then
		echo "[!] failed to get versions from https://www.lua.org/ftp/ falling back to version $version"
	else
		if ! version="$(printf '%s' "$versions" | tr ' ' '\n' | fzf)"
		then
			echo "[!] aborting"
			exit 1
		fi
		if [ "$version" = "" ]
		then
			echo "[!] aborting"
			exit 1
		fi
	fi
	version="$(basename "$version" .tar.gz)"
	if [[ "$version" =~ [0-9]+\.[0-9]+ ]]
	then
		abi_version="${BASH_REMATCH[0]}"
	else
		echo "[-] Error: failed to parse lua abi version from version '$version'"
		exit 1
	fi

	if [ -f "$version".tar.gz ] || [ -d "$version" ]
	then
		echo "[-] Error: the version $version is already installed"
		exit 1
	fi

	curl -L -R -O https://www.lua.org/ftp/"$version".tar.gz
	tar zxf "$version".tar.gz
	cd "$version"
	make all test

	# install files to a local directory
	# make install INSTALL_TOP=$PWD/install
	make local

	# manually copy them to the system wide location
	# and patch in the version number to properly
	# support lua multi version support that is also
	# picked up by luarocks
	sudo mkdir -p /usr/local/include/lua"$abi_version"
	sudo cp install/include/*.h /usr/local/include/lua"$abi_version"
	sudo cp install/lib/liblua.a /usr/local/lib/liblua${abi_version}.a
	sudo cp install/bin/lua /usr/local/bin/lua${abi_version}
	sudo cp install/bin/luac /usr/local/bin/luac${abi_version}

	if [ -f "$CM_BIN_PATH"/lua ]
	then
		echo "[!] overwriting old lua in PATH"
		rm "$CM_BIN_PATH"/lua
	fi
	if [ -f "$CM_BIN_PATH"/luac ]
	then
		echo "[!] overwriting old luac in PATH"
		rm "$CM_BIN_PATH"/luac
	fi

	ln -s /usr/local/bin/lua${abi_version} "$CM_BIN_PATH"/lua
	ln -s /usr/local/bin/luac${abi_version} "$CM_BIN_PATH"/luac

	if [ -x "$(command -v luarocks)" ]
	then
		include_dir="/usr/local/include/lua${abi_version}"
		echo "[*] configure luarocks to use $include_dir"
		luarocks config variables.LUA_INCDIR "$include_dir"
	fi
fi
