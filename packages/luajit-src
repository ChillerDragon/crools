#!/bin/bash

set -eu

CM_BIN_PATH="$HOME/.config/crools/crackman/bin"
CM_SRC_PATH="$HOME/.config/crools/crackman/src"

mkdir -p "$CM_BIN_PATH"
mkdir -p "$CM_SRC_PATH"

if [ "${1:-}" == "description" ]
then
	echo "Just-In-Time Compiler for Lua"
elif [ "${1:-}" == "delete" ]
then
	cd "$CM_SRC_PATH"/luajit
	sudo make uninstall
	cd ..
	rm -rf "$CM_SRC_PATH"/luajit
elif [ "${1:-}" == "is_installed?" ]
then
	if [ -d "$CM_SRC_PATH"/luajit ]
	then
		echo "yes"
		exit 1
	else
		echo "no"
		exit 0
	fi
else
	distro="$(grep "^ID=" /etc/os-release | cut -d'=' -f2)"
	if [ "$distro" = "debian" ]
	then
		if [ ! -x "$(command -v fzf)" ]
		then
			sudo apt-get install -y fzf || exit 1
		fi
	fi

	cd "$CM_SRC_PATH" || exit 1
	if [ ! -d "luajit" ]
	then
		git clone https://luajit.org/git/luajit.git
	fi
	cd luajit
	tag="$( (git tag && printf 'master\n') | fzf)"
	if [ "$tag" == "" ]
	then
		echo "Error: invalid tag"
		exit 1
	fi
	git pull
	git checkout "$tag" || exit 1
	git pull

	make
	sudo make install
fi

