#!/bin/bash

function git_save_pull() {
    local repo
    repo=${1:-crools}
    if [ "$(git status | tail -n1)" != "nothing to commit, working tree clean" ]
    then
        echo "WARNING: git pull failed! Is your $repo working tree clean?"
        return
    fi
	echo "[*] updating $repo ..."
    git pull
}
function is_func() {
    declare -f -F "$1" > /dev/null
    return $?
}
function is_apple() {
    if [[ "$OSTYPE" == "darwin"* ]]
    then
        return 0
    fi
    return 1
}

crools_dir="${0%/*}"
if [ ! -d "$crools_dir" ]
then
    echo "Error: invalid crools dir"
    echo "$crools_dir"
    exit 1
fi

cd "$crools_dir" || exit 1

if [ "$1" == "--dev" ]
then
    exec "$SHELL"
else
    git_save_pull
fi

if [ -d ../dotfiles ] && [ -f ../dotfiles/setup.sh ]
then
    cd ../dotfiles || exit 1
    if git remote -v | grep -q '^origin.*ChillerDragon/dotfiles '
    then
        git_save_pull dotfiles
        ./setup.sh
    fi
fi

if is_func pullpw
then
    pullpw
fi

if [ ! -x "$(command -v cstd)" ]
then
    echo "[*] installing dependency cstd"
    sudo wget -O /usr/local/bin/cstd https://paste.zillyhuhn.com/0 && \
        sudo chmod +x /usr/local/bin/cstd
fi

shellrc=~/.bashrc
if is_apple
then
    shellrc=~/.bash_profile
fi

if ! echo "$PATH" | grep -q crools
then
    echo "[*] adding crools to path ..."
    echo "export PATH=\"\$PATH:$crools_dir\"" >> "$shellrc"
fi

if ! is_func whereami && ! grep -q whereami "$shellrc"
then
    echo "[*] installing shell functions ..."
    echo '
whereami() {
    echo -e "STY: \033[0;31m$STY\033[0m"
    ps wwf -s $$
}
' >> "$shellrc"
fi

